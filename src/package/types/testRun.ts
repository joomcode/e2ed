import type {TestRunStatus} from '../constants/internal';
import type {E2EDError} from '../utils/E2EDError';

import type {Brand} from './brand';
import type {UtcTimeInMs} from './date';
import type {DeepReadonly} from './deep';
import type {TestRunEvent} from './events';
import type {TestFilePath} from './fs';
import type {TestMeta} from './userland/types';

/**
 * Reject test run.
 */
export type RejectTestRun = (error: E2EDError) => void;

/**
 * Hash string of each test run, generated by userland hook.
 * Used in html report as url-hash for test runs.
 */
export type RunHash = Brand<string, 'RunHash'>;

/**
 * Unique id of each test run.
 */
export type RunId = Brand<string, 'RunId'>;

/**
 * Test function itself.
 */
export type TestFn = () => Promise<void>;

/**
 * Test options.
 */
export type TestOptions = DeepReadonly<{
  meta: TestMeta;
  testIdleTimeout?: number;
  testTimeout?: number;
}>;

/**
 * The complete static test options, that is, the options
 * available from the code before the tests are run.
 */
export type TestStaticOptions = Readonly<{
  filePath: TestFilePath;
  name: string;
  options: TestOptions;
}>;

/**
 * Completed test run object.
 * Not internal because it used in user hooks.
 */
export type TestRun = Readonly<{
  endTimeInMs: UtcTimeInMs;
  runError: string | undefined;
  startTimeInMs: UtcTimeInMs;
}> &
  Omit<TestRunEvent, 'onlog' | 'previousRunId' | 'reject' | 'testFnWithReject' | 'utcTimeInMs'>;

/**
 * The complete test options, that is, all information about the test
 * that is input to the test function.
 * @internal
 */
export type Test = Readonly<{testFn: TestFn}> & Omit<TestStaticOptions, 'filePath'>;

/**
 * Lite test run object.
 */
export type LiteTestRun = Readonly<{
  endTimeInMs: UtcTimeInMs;
  mainParams: string;
  runError: string | undefined;
  runHash: RunHash;
  startTimeInMs: UtcTimeInMs;
  status: TestRunStatus;
}> &
  TestStaticOptions;

/**
 * Full test run object result of userland hooks (like mainParams and runHash).
 * @internal
 */
export type FullTestRun = Readonly<{mainParams: string; runHash: RunHash}> & TestRun;
